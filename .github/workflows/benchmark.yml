name: OpenAPI Benchmark

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Compare OpenAPI generation speed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Benchmark head
        run: bash scripts/benchmark-openapi.sh --label head --output benchmark-head.json --repo "$GITHUB_WORKSPACE"

      - name: Checkout base
        run: git worktree add /tmp/base ${{ github.event.pull_request.base.sha }}

      - name: Install base dependencies
        run: pnpm -C /tmp/base install --frozen-lockfile

      - name: Benchmark base
        run: bash /tmp/base/scripts/benchmark-openapi.sh --label base --output benchmark-base.json --repo /tmp/base

      - name: Cleanup
        if: always()
        run: git worktree remove /tmp/base --force || true

      - name: Format results
        run: node scripts/format-benchmark-comment.mjs benchmark-base.json benchmark-head.json benchmark-comment.md

      - name: Find comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: '<!-- benchmark-openapi -->'

      - uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body-file: benchmark-comment.md
          edit-mode: replace
